#define LOG_TAG "flashlight_jni"#include <stdio.h>#include <sys/ioctl.h>#include <sys/types.h>#include <sys/stat.h>#include <fcntl.h>#include <string.h>#include <errno.h>#include <cutils/log.h>#include <unistd.h>#include "kd_flashlight.h"#include "fljni.h"#define DEV_PATH "/dev/kd_camera_flashlight"struct flash_light{	int flfd;	kdStrobeDrvArg ksa;};static struct flash_light flt = {0,{1,1,0}};static int _setDevice(int deviceid,int ledid){	int ret = 0;	flt.ksa.sensorDev = deviceid;	flt.ksa.strobeId = ledid;	ret = ioctl(flt.flfd,FLASHLIGHTIOC_X_SET_DRIVER,&flt.ksa);	if(ret){		ALOGE("SET_DRIVER ret=%d err(%s)",ret,strerror(errno));		ret = -2;	}	return ret;}static int fltNativeInit(void){	int ret = 0;	ALOGD("%s e\n",__func__);//	execlp("sh","su root;chmod 777 "DEV_PATH);	if(!flt.flfd){		flt.flfd = open(DEV_PATH,O_RDWR);		if(flt.flfd <= 0){			ALOGE("open  err(%s)",strerror(errno));			ret = -1;		}else			ret = _setDevice(1,1) + _setDevice(1,2) + _setDevice(2,1);	}	ALOGD("%s flt.flfd=%d ret=%d x\n",__func__,flt.flfd,ret);	return ret;}static void fltNativeDeInit(void){	memset(&flt,0,sizeof(flt));	close(flt.flfd);}static int fltNativeTimeout(int timeout){	int ret = 0;	flt.ksa.arg = timeout;	ret = ioctl(flt.flfd,FLASH_IOC_SET_TIME_OUT_TIME_MS,&flt.ksa);	if(ret){		ALOGE("TIME_OUT_TIME_MS ret=%d err(%s)",ret,strerror(errno));		ret = -3;	}	return ret;}static int fltNativeSelectDevice(int deviceid,int ledid){	int ret = 0;	flt.ksa.sensorDev = deviceid;	flt.ksa.strobeId = ledid;	return ret;}static int fltNativeSetDuty(int duty){	int ret = 0;	flt.ksa.arg = duty;	ret = ioctl(flt.flfd,FLASH_IOC_SET_DUTY,&flt.ksa);	if(ret){		ALOGE("duty ret=%d err(%s)",ret,strerror(errno));		ret = -4;	}	return ret;}static int fltNativeOnOff(int onoff){	int ret = 0;	flt.ksa.arg = onoff;	ret = ioctl(flt.flfd,FLASH_IOC_SET_ONOFF,&flt.ksa);	if(ret){		ALOGE("ioctl onoff ret=%d err(%s)",ret,strerror(errno));		ret = -5;	}	return ret;}/* * Class:     com_leaf_flashlightcontrol_FlashLightAction * Method:    fltNativeInit * Signature: ()I */JNIEXPORT jint JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeInit  (JNIEnv *env, jobject object){	return fltNativeInit();}/* * Class:     com_leaf_flashlightcontrol_FlashLightAction * Method:    fltNativeDeInit * Signature: ()V */JNIEXPORT void JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeDeInit  (JNIEnv *env, jobject object){	return fltNativeDeInit();}/* * Class:     com_leaf_flashlightcontrol_FlashLightAction * Method:    fltNativeSelectDevice * Signature: (I)I */JNIEXPORT jint JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeSelectDevice  (JNIEnv *env, jobject object, jint deviceid,jint ledid){	return fltNativeSelectDevice(deviceid,ledid);}/* * Class:     com_leaf_flashlightcontrol_FlashLightAction * Method:    fltNativeSetDuty * Signature: (I)I */JNIEXPORT jint JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeSetDuty  (JNIEnv *env, jobject object, jint duty){	return fltNativeSetDuty(duty);}/* * Class:     com_leaf_flashlightcontrol_FlashLightAction * Method:    fltNativeOnOff * Signature: (I)I */JNIEXPORT jint JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeOnOff  (JNIEnv *env, jobject object, jint onoff){	return fltNativeOnOff(onoff);}JNIEXPORT jint JNICALL Java_com_leaf_flashlightcontrol_FlashLightAction_fltNativeTimeout  (JNIEnv *env, jobject object, jint timeout){	return fltNativeTimeout(timeout);}int main(int argc,char **argv){	int ret = -1;	ret = fltNativeInit();	if(ret < 0)		return ret;	sleep(1);//ledid 1	ret = fltNativeSelectDevice(1,1);	ALOGD("fltNativeSelectDevice ret=%d\n",ret);	ret = fltNativeSetDuty(1);	ALOGD("fltNativeSetDuty ret=%d\n",ret);	fltNativeTimeout(0);	ret = fltNativeOnOff(1);	ALOGD("fltNativeOnOff ret=%d\n",ret);//ledid 2		ret =fltNativeSelectDevice(1,2);	ALOGD("fltNativeSelectDevice ret=%d\n",ret);	ret = fltNativeSetDuty(1);	ALOGD("fltNativeSetDuty ret=%d\n",ret);	fltNativeTimeout(0);	ret = fltNativeOnOff(1);	ALOGD("fltNativeOnOff ret=%d\n",ret);	sleep(10);	fltNativeSelectDevice(1,1);	fltNativeOnOff(0);	fltNativeSelectDevice(1,2);	fltNativeOnOff(0);	fltNativeDeInit();	return 0;}